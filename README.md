# xmlui-codefence-runner

This app is a small authoring tool and standalone runner for XMLUI `xmlui-pg` codefences. It reproduces the behavior of playground.xmlui.org without requiring the entire XMLUI dev environment.

Why? From our blog post on [Reproducible XMLUI](https://blog.xmlui.org/blog/xmlui-playground):

> Open source developers who respond to bug reports always hope for, but rarely get, reliable ways to reproduce the bad behavior they are seeing. Now those reports can contain XMLUI codefences that exhibit the behavior.
If you want to make such a report, you can visit xmlui-codefence-runner.netlify.app, paste in your codefence, open it into a playground, and share its URL.

## What it does

- Lets you edit Markdown that contains ` ```xmlui-pg ` fences.

- Uses the XMLUI runtime's `Markdown` component to parse `xmlui-pg` fences into
  embedded playgrounds.

- Runs the embedded app, components, and mock API inside the page.

- Optionally opens the playground in a full hosted playground window.

## How it works

### Runtime

`index.html` loads the XMLUI standalone runtime from the docs CDN.
That runtime already knows how to parse and render `xmlui-pg` fences via the built-in `Markdown` component. (We do not call `window.preprocessMarkdown` here; the runtime handles it internally.)

### App shell

`Main.xmlui` is the UI. Itâ€™s just a text area and a `Markdown` component:

### Mock API support

When a `---api` block is present, the runtime creates an MSW interceptor. MSW
expects a service worker script at the site root. For this runner we provide
`mockApi.js`, which is an MSW (Mock Service Worker) script generated by the
`msw` CLI (`npx msw init <PUBLIC_DIR>`).
`/Users/jonudell/xmlui/docs/public/mockServiceWorker.js`.

This file must be served at `http://localhost:8080/mockApi.js` (or whatever
host you use). Without it, the worker registration fails and `---api` blocks
will not work.

### Hosted playground pop-out

The hosted playground can fail to register a service worker because it
does not serve `/mockServiceWorker.js` at the root. To avoid that error, the
runner rewrites the pop-out payload to disable the worker in `playground-popout-fix.js`.

This script wraps `window.open` and, when the target is
`https://playground.xmlui.org/#/playground#...`, it:

- Decodes and decompresses the payload.

- Sets `standalone.api.useWorker = false`.

- Re-compresses and re-encodes the payload.

- Navigates the new window to the rewritten URL.

## Notes and constraints

- The runtime parses API JSON with `JSON.parse` after stripping newlines. This
  is why multiline strings inside `---api` blocks still work, but non-JSON
  syntax (comments, trailing commas, etc.) does not.

- Service workers persist per origin. If you change or remove `mockApi.js`,
  unregister the existing worker in the browser to avoid stale warnings:
  - DevTools -> Application -> Service Workers -> unregister for your host.
  - Or run this in the console and reload:
    ```js
    navigator.serviceWorker.getRegistrations().then(r => r.forEach(x => x.unregister()));
    ```

## Files to know

- `index.html`: loads the runtime and support scripts.
- `Main.xmlui`: UI for editing and running codefences.
- `mockApi.js`: MSW service worker used by `---api` fences.
- `playground-popout-fix.js`: disables MSW worker in hosted pop-outs.
